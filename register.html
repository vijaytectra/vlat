<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VLAT Entrance Exam Register</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#8D191C",
              cream: "#FFF6E5",
              gold: "#EDCD88",
              whiteSoft: "#F3F4F6",
            },
          },
        },
      };
    </script>
    <style>
      input::placeholder {
        color: #a3a3a3;
        font-size: 0.875rem;
        font-weight: 500;
        font-family: "Inter", sans-serif;
      }
    </style>
  </head>

  <body class="font-['Inter']" style="background-color: #fff6e2">
    <!-- ROOT GRID -->
    <main class="min-h-screen grid grid-cols-1 lg:grid-cols-[96px_1.2fr_1fr]">
      <!-- LEFT RED STRIP -->
      <aside class="hidden lg:block w-72 bg-primary relative">
        <button
          onclick="history.back()"
          class="absolute top-6 left-32 z-20 flex items-center gap-2 text-sm font-medium uppercase border border-white/40 rounded-full px-3 py-1 text-[#A3A3A3] backdrop-blur"
        >
          <i class="fas fa-chevron-left text-xs"></i>
          BACK
        </button>
      </aside>

      <section
        class="hidden z-10 lg:flex items-center justify-start h-full px-10 pt-10"
      >
        <img
          src="images/loginImage.svg"
          alt="Students attending class"
          class="h-full max-h-[85%] w-auto object-contain"
        />
      </section>

      <!-- FORM COLUMN -->
      <section class="flex items-center justify-center px-4 py-10">
        <div class="w-full max-w-md space-y-4">
          <!-- LOGO -->
          <div class="flex justify-center">
            <img src="images/logo1.svg" alt="VMLS Logo" class="h-14" />
          </div>

          <!-- TITLE -->
          <div class="text-center space-y-1">
            <h1 class="text-3xl font-bold font-['Inter'] text-primary">
              VLAT Entrance Exam Register
            </h1>
            <p
              class="text-sm font-normal font-['Arial'] leading-6 text-[#404040]"
            >
              Please fill in the details below to register for the VLAT Entrance
              Exam.
            </p>
          </div>

          <!-- FORM CARD -->
          <form id="registerForm" class="rounded-3xl p-6 space-y-4 bg-primary">
            <!-- ERROR MESSAGE -->
            <div
              id="errorMessage"
              class="hidden flex items-center gap-2 bg-white text-red-600 text-xs px-3 py-2 rounded-full"
            >
              <i class="fas fa-circle-exclamation"></i>
              <span id="errorText"></span>
            </div>

            <!-- NAME -->
            <div>
              <label class="text-sm font-light text-[#F3F4F6]">Name</label>
              <input
                id="name"
                type="text"
                placeholder="Enter your Full name"
                class="mt-1 w-full h-8 rounded-md bg-[#FFFFFF1A] border border-[#FFFFFF33] px-3 outline-none"
                style="color: #ffffff"
                required
              />
            </div>

            <!-- EMAIL -->
            <div>
              <label
                class="text-sm font-light text-[#F3F4F6]"
                style="color: #f3f4f6"
                >Email ID</label
              >
              <input
                id="email"
                type="email"
                placeholder="Enter your Email ID"
                class="mt-1 w-full h-8 rounded-md bg-[#FFFFFF1A] border border-[#FFFFFF33] px-3 outline-none"
                style="color: #ffffff"
                required
              />
            </div>

            <!-- CONTACT -->
            <div>
              <label
                class="text-sm font-light text-[#F3F4F6]"
                style="color: #f3f4f6"
                >Contact Number</label
              >
              <input
                id="contactNumber"
                type="tel"
                placeholder="Enter your Contact number (10 digits)"
                class="mt-1 w-full h-8 rounded-md bg-[#FFFFFF1A] border border-[#FFFFFF33] px-3 outline-none"
                style="color: #ffffff"
                required
                maxlength="10"
              />
            </div>

            <!-- PASSWORD -->
            <div>
              <label
                class="text-sm font-light text-[#F3F4F6]"
                style="color: #f3f4f6"
                >Password</label
              >
              <input
                id="password"
                type="password"
                placeholder="Enter New Password"
                class="mt-1 w-full h-8 rounded-md bg-[#FFFFFF1A] border border-[#FFFFFF33] px-3 outline-none"
                style="color: #ffffff"
                required
              />
              <p class="text-xs text-[#D4D4D4] mt-1">
                Must be at least 8 characters with uppercase, lowercase, number,
                and special character
              </p>
            </div>

            <!-- CONFIRM -->
            <div>
              <label
                class="text-sm font-light text-[#F3F4F6]"
                style="color: #f3f4f6"
                >Confirm Password</label
              >
              <input
                id="confirmPassword"
                type="password"
                placeholder="Enter Confirm Password"
                class="mt-1 w-full h-8 rounded-md bg-[#FFFFFF1A] border border-[#FFFFFF33] px-3 outline-none"
                style="color: #ffffff"
                required
              />
            </div>

            <!-- BUTTON -->
            <button
              type="submit"
              id="registerButton"
              class="w-full h-10 text-base font-medium text-[#8D191C] rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
              style="background-color: #fff6e2; color: #8d191c"
            >
              <span id="registerButtonText">Register Now</span>
              <span id="registerButtonLoader" class="hidden">
                <i class="fas fa-spinner fa-spin"></i> Registering...
              </span>
            </button>

            <!-- HELP -->
            <div class="border-t border-[#FFFFFF33] pt-3 space-y-2">
              <p
                class="text-center text-sm font-normal font-['Inter'] leading-5"
                style="color: #d4d4d4"
              >
                Need help with login?
              </p>
              <div
                class="flex justify-between gap-2 text-sm font-normal font-['Inter'] leading-5"
                style="color: #d4d4d4"
              >
                <span
                  ><i class="fas fa-envelope"></i> admissions@vmls.edu.in</span
                >
                <span><i class="fas fa-phone"></i> +91 73582 01234</span>
              </div>
            </div>
          </form>
        </div>
      </section>
    </main>
    <script type="module">
      import { register } from "./js/auth.js";

      const form = document.getElementById("registerForm");
      const nameInput = document.getElementById("name");
      const emailInput = document.getElementById("email");
      const contactInput = document.getElementById("contactNumber");
      const passwordInput = document.getElementById("password");
      const confirmPasswordInput = document.getElementById("confirmPassword");
      const errorMessage = document.getElementById("errorMessage");
      const errorText = document.getElementById("errorText");
      const registerButton = document.getElementById("registerButton");
      const registerButtonText = document.getElementById("registerButtonText");
      const registerButtonLoader = document.getElementById(
        "registerButtonLoader"
      );

      // Hide error message initially
      errorMessage.classList.add("hidden");

      // Validate password complexity
      function validatePassword(password) {
        if (password.length < 8) {
          return {
            valid: false,
            message: "Password must be at least 8 characters long",
          };
        }
        if (!/[A-Z]/.test(password)) {
          return {
            valid: false,
            message: "Password must contain at least one uppercase letter",
          };
        }
        if (!/[a-z]/.test(password)) {
          return {
            valid: false,
            message: "Password must contain at least one lowercase letter",
          };
        }
        if (!/[0-9]/.test(password)) {
          return {
            valid: false,
            message: "Password must contain at least one number",
          };
        }
        if (!/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
          return {
            valid: false,
            message: "Password must contain at least one special character",
          };
        }
        return { valid: true };
      }

      // Validate contact number (10 digits)
      function validateContactNumber(contactNumber) {
        const cleaned = contactNumber.replace(/\D/g, "");
        if (cleaned.length !== 10) {
          return {
            valid: false,
            message: "Contact number must be exactly 10 digits",
          };
        }
        return { valid: true, cleaned };
      }

      // Validate email format
      function validateEmail(email) {
        const emailRegex = /^\S+@\S+\.\S+$/;
        return emailRegex.test(email);
      }

      function showError(message) {
        errorText.textContent = message;
        errorMessage.classList.remove("hidden");
      }

      function hideError() {
        errorMessage.classList.add("hidden");
      }

      // Helper function to reset button state
      function resetButtonState() {
        registerButton.disabled = false;
        registerButtonText.classList.remove("hidden");
        registerButtonLoader.classList.add("hidden");
      }

      // Helper function to set loading state
      function setLoadingState() {
        registerButton.disabled = true;
        registerButtonText.classList.add("hidden");
        registerButtonLoader.classList.remove("hidden");
      }

      // Contact number input - only allow digits
      contactInput.addEventListener("input", (e) => {
        e.target.value = e.target.value.replace(/\D/g, "").slice(0, 10);
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        hideError();

        // Get form values
        const name = nameInput.value.trim();
        const email = emailInput.value.trim();
        const contactNumber = contactInput.value.trim();
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        // Validate required fields
        if (
          !name ||
          !email ||
          !contactNumber ||
          !password ||
          !confirmPassword
        ) {
          showError("All fields are required");
          return;
        }

        // Validate email
        if (!validateEmail(email)) {
          showError("Please enter a valid email address");
          return;
        }

        // Validate contact number
        const contactValidation = validateContactNumber(contactNumber);
        if (!contactValidation.valid) {
          showError(contactValidation.message);
          return;
        }

        // Validate password
        const passwordValidation = validatePassword(password);
        if (!passwordValidation.valid) {
          showError(passwordValidation.message);
          return;
        }

        // Check if passwords match
        if (password !== confirmPassword) {
          showError("Passwords do not match");
          return;
        }

        // Show loading state
        setLoadingState();

        try {
          // Call register API
          const result = await register({
            name,
            email,
            contactNumber: contactValidation.cleaned,
            password,
            confirmPassword,
          });

          if (result.success) {
            // Small delay to ensure session cookie is set before redirect
            // This helps with cross-origin cookie issues
            await new Promise((resolve) => setTimeout(resolve, 100));

            // Verify authentication before redirecting
            try {
              const { checkAuth } = await import("./js/auth.js");
              const authCheck = await checkAuth();

              if (authCheck.authenticated) {
                // Redirect to dashboard
                window.location.href = "dashboard.html";
              } else {
                // If auth check fails, still redirect but log warning
                console.warn("Session may not be set, redirecting anyway");
                window.location.href = "dashboard.html";
              }
            } catch (authError) {
              console.error("Auth check error:", authError);
              // Still redirect - dashboard will handle auth check
              window.location.href = "dashboard.html";
            }
          } else {
            // Show error message
            showError(
              result.message || "Registration failed. Please try again."
            );
            resetButtonState();
          }
        } catch (error) {
          console.error("Registration error:", error);
          // Log full error details for debugging
          if (error.message) {
            console.error("Error message:", error.message);
          }
          if (error.stack) {
            console.error("Error stack:", error.stack);
          }

          // Show user-friendly error message
          const errorMessage = error.message
            ? `An error occurred: ${error.message}`
            : "An error occurred. Please check your connection and try again.";
          showError(errorMessage);
          resetButtonState();
        }
      });
    </script>
  </body>
</html>
