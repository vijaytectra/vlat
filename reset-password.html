<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Reset Password</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />

    <!-- Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />

    <!-- Compiled Tailwind CSS -->
    <link rel="stylesheet" href="css/main.css?v=2.0" />
    <style>
      input::placeholder {
        color: #a3a3a3;
        font-size: 0.875rem;
        font-weight: 500;
        font-family: "Inter", sans-serif;
      }
    </style>
  </head>

  <body class="font-['Inter']" style="background-color: #fff6e2">
    <!-- Language Switcher - Top Right -->
    <div class="fixed top-4 right-4 z-50">
      <div
        class="language-switcher flex items-center gap-0 border border-grey-5 rounded-lg overflow-hidden bg-white shadow-md"
      >
                <button
                  data-lang="en"
                  class="lang-btn px-3 py-1.5 text-sm font-medium transition-colors active"
                >
                  English
                </button>
                <button
                  data-lang="ta"
                  class="lang-btn px-3 py-1.5 text-sm font-medium transition-colors inactive"
                >
                  தமிழ்
        </button>
      </div>
    </div>

    <!-- ROOT GRID -->
    <main class="grid grid-cols-1 lg:grid-cols-[96px_1.2fr_1fr]">
      <!-- LEFT RED STRIP -->
      <aside class="hidden lg:block w-72 bg-primary relative">
        <button
          onclick="history.back()"
          class="absolute top-6 left-32 z-20 flex items-center gap-2 text-sm font-medium uppercase border border-white/40 rounded-full px-3 py-1 text-[#A3A3A3] backdrop-blur"
          data-i18n="common.buttons.back"
        >
          <i class="fas fa-chevron-left text-xs"></i>
          BACK
        </button>
      </aside>

      <section
        class="hidden z-10 lg:flex items-center justify-start h-full px-10 pt-10"
      >
        <img
          src="images/loginimage.png"
          alt="Students attending class"
          class="h-full max-h-[85%] w-auto object-contain"
        />
      </section>

      <!-- FORM COLUMN -->
      <!-- FORM COLUMN -->
      <section class="flex items-start justify-center px-4 pt-20">
        <div class="w-full max-w-md space-y-4">
          <!-- LOGO -->
          <div class="flex justify-center">
            <img src="images/logo1.svg" alt="VMLS Logo" class="h-14" />
          </div>

          <!-- TITLE -->
          <div class="text-center space-y-1">
            <h1 class="text-4xl font-bold text-primary" data-i18n="pages.resetPassword.title">Reset Password</h1>
            <p class="text-sm leading-6 text-[#404040]" data-i18n="pages.resetPassword.subtitle">
              Set a new password for your account.
            </p>
          </div>

          <!-- FORM CARD -->
          <form
            id="resetPasswordForm"
            class="rounded-3xl p-6 space-y-4 bg-primary"
          >
            <!-- ERROR MESSAGE -->
            <div
              id="errorMessage"
              class="hidden flex items-center gap-2 bg-white text-red-600 text-xs px-3 py-2 rounded-full"
            >
              <i class="fas fa-circle-exclamation"></i>
              <span id="errorText"></span>
            </div>

            <!-- TOKEN INVALID MESSAGE -->
            <div
              id="tokenInvalidMessage"
              class="hidden flex items-center gap-2 bg-white text-red-600 text-xs px-3 py-2 rounded-full"
            >
              <i class="fas fa-circle-exclamation"></i>
              <span data-i18n="pages.resetPassword.errors.tokenInvalid"
                >Invalid or expired reset link. Please request a new password
                reset.</span
              >
            </div>

            <!-- Password -->
            <div>
              <label class="text-sm text-[#F3F4F6]" data-i18n="pages.resetPassword.passwordLabel">Password</label>
              <input
                id="password"
                type="password"
                data-i18n-placeholder="pages.resetPassword.passwordPlaceholder"
                placeholder="Enter your new password"
                class="mt-1 w-full h-10 rounded-md bg-[#FFFFFF1A] border border-[#FFFFFF33] px-3 text-white outline-none"
                style="color: #ffffff"
                required
              />
              <p class="text-xs text-[#D4D4D4] mt-1" data-i18n="pages.resetPassword.passwordHint">
                Must be at least 8 characters with uppercase, lowercase, number,
                and special character
              </p>
            </div>

            <!-- Confirm Password -->
            <div>
              <label class="text-sm text-[#F3F4F6]" data-i18n="pages.resetPassword.confirmPasswordLabel">Confirm Password</label>
              <input
                id="confirmPassword"
                type="password"
                data-i18n-placeholder="pages.resetPassword.confirmPasswordPlaceholder"
                placeholder="Enter your new password again"
                class="mt-1 w-full h-10 rounded-md bg-[#FFFFFF1A] border border-[#FFFFFF33] px-3 text-white outline-none"
                style="color: #ffffff"
                required
              />
            </div>
            <!-- Button -->
            <button
              type="submit"
              id="resetButton"
              class="w-full h-11 rounded-lg bg-[#FFF6E2] text-primary font-medium disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <span id="resetButtonText" data-i18n="pages.resetPassword.submitButton">Update password</span>
              <span id="resetButtonLoader" class="hidden">
                <i class="fas fa-spinner fa-spin"></i> <span data-i18n="pages.resetPassword.updating">Updating...</span>
              </span>
            </button>

            <p class="text-center text-xs text-[#FAFAFA]" data-i18n="pages.resetPassword.passwordRequirement">
              Password must be at least 8 characters with uppercase, lowercase,
              number, and special character
            </p>
          </form>
        </div>
      </section>
    </main>
    <!-- Translation System -->
    <script src="js/translations.js"></script>
    <script type="module">
      import { verifyResetToken, resetPassword } from "./js/auth.js";

      const form = document.getElementById("resetPasswordForm");
      const passwordInput = document.getElementById("password");
      const confirmPasswordInput = document.getElementById("confirmPassword");
      const errorMessage = document.getElementById("errorMessage");
      const errorText = document.getElementById("errorText");
      const tokenInvalidMessage = document.getElementById(
        "tokenInvalidMessage"
      );
      const resetButton = document.getElementById("resetButton");
      const resetButtonText = document.getElementById("resetButtonText");
      const resetButtonLoader = document.getElementById("resetButtonLoader");

      // Hide error messages initially
      errorMessage.classList.add("hidden");
      tokenInvalidMessage.classList.add("hidden");

      // Get token and email from URL
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get("token");
      const email = urlParams.get("email");

      // Validate password complexity
      function validatePassword(password) {
        if (password.length < 8) {
          return {
            valid: false,
            message: t("pages.resetPassword.errors.passwordTooShort", "Password must be at least 8 characters long"),
          };
        }
        if (!/[A-Z]/.test(password)) {
          return {
            valid: false,
            message: t("pages.resetPassword.errors.passwordNoUppercase", "Password must contain at least one uppercase letter"),
          };
        }
        if (!/[a-z]/.test(password)) {
          return {
            valid: false,
            message: t("pages.resetPassword.errors.passwordNoLowercase", "Password must contain at least one lowercase letter"),
          };
        }
        if (!/[0-9]/.test(password)) {
          return {
            valid: false,
            message: t("pages.resetPassword.errors.passwordNoNumber", "Password must contain at least one number"),
          };
        }
        if (!/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
          return {
            valid: false,
            message: t("pages.resetPassword.errors.passwordNoSpecial", "Password must contain at least one special character"),
          };
        }
        return { valid: true };
      }

      function showError(message) {
        errorText.textContent = message;
        errorMessage.classList.remove("hidden");
        tokenInvalidMessage.classList.add("hidden");
      }

      function hideError() {
        errorMessage.classList.add("hidden");
      }

      function showTokenInvalid() {
        tokenInvalidMessage.classList.remove("hidden");
        errorMessage.classList.add("hidden");
        form.style.opacity = "0.5";
        form.style.pointerEvents = "none";
        resetButton.disabled = true;
      }

      // Verify token on page load
      async function verifyToken() {
        if (!token || !email) {
          showTokenInvalid();
          return false;
        }

        try {
          const result = await verifyResetToken(token, email);
          if (!result.valid) {
            showTokenInvalid();
            return false;
          }
          return true;
        } catch (error) {
          console.error("Token verification error:", error);
          showTokenInvalid();
          return false;
        }
      }

      // Verify token when page loads
      verifyToken().then((isValid) => {
        if (!isValid) {
          // Add a link to request new reset
          const linkContainer = document.createElement("div");
          linkContainer.className = "text-center mt-4";
          const link = document.createElement("a");
          link.href = "forgot-password.html";
          link.className = "text-[#EDCD88] text-sm hover:underline";
          link.setAttribute("data-i18n", "pages.resetPassword.requestNewLink");
          link.textContent = t("pages.resetPassword.requestNewLink", "Request a new password reset link");
          linkContainer.appendChild(link);
          form.parentElement.appendChild(linkContainer);
          
          // Re-translate to ensure the link is translated
          if (typeof translatePage === 'function') {
            translatePage();
          }
        }
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        hideError();

        if (!token || !email) {
          showError(t("pages.resetPassword.errors.invalidLink", "Invalid reset link"));
          return;
        }

        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        // Validate required fields
        if (!password || !confirmPassword) {
          showError(t("pages.resetPassword.errors.fieldsRequired", "Please fill in all fields"));
          return;
        }

        // Validate password
        const passwordValidation = validatePassword(password);
        if (!passwordValidation.valid) {
          showError(passwordValidation.message);
          return;
        }

        // Check if passwords match
        if (password !== confirmPassword) {
          showError(t("pages.resetPassword.errors.passwordMismatch", "Passwords do not match"));
          return;
        }

        // Show loading state
        resetButton.disabled = true;
        resetButtonText.classList.add("hidden");
        resetButtonLoader.classList.remove("hidden");

        try {
          const result = await resetPassword(
            token,
            email,
            password,
            confirmPassword
          );

          if (result.success) {
            // Redirect to login page
            window.location.href = "login.html";
          } else {
            showError(
              result.message || t("pages.resetPassword.errors.failed", "Failed to reset password. Please try again.")
            );
            resetButton.disabled = false;
            resetButtonText.classList.remove("hidden");
            resetButtonLoader.classList.add("hidden");
          }
        } catch (error) {
          console.error("Reset password error:", error);
          showError(t("pages.resetPassword.errors.generic", "An error occurred. Please try again."));
          resetButton.disabled = false;
          resetButtonText.classList.remove("hidden");
          resetButtonLoader.classList.add("hidden");
        }
      });

      // Initialize translations on page load
      document.addEventListener("DOMContentLoaded", async () => {
        if (typeof initializeTranslations === "function") {
          await initializeTranslations();
        }

        // Re-translate when language changes
        window.addEventListener("languageChanged", () => {
          if (typeof translatePage === "function") {
            translatePage();
          }
        });
      });
    </script>
  </body>
</html>
